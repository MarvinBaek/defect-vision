<h3>ğŸ“ CCTV ì˜ìƒ ì„ íƒ</h3>
<select id="cctvSelect">
  <option value="">-- CCTV ì˜ìƒ ì„ íƒ --</option>
</select>
<button id="startAnalysisBtn">ë¶„ì„ ì‹œì‘</button>

<h3>ğŸ“¡ ìŠ¤íŠ¸ë¦¬ë° ì¤‘</h3>
<img id="streaming" alt="ìŠ¤íŠ¸ë¦¬ë° ê²°ê³¼" style="display:none; max-width: 100%; border: 1px solid #ccc;" />

<video id="resultVideo" controls style="display:none; max-width:100%;">
  <source id="resultSource" type="video/mp4" />
  ë¸Œë¼ìš°ì €ê°€ video íƒœê·¸ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
</video>

<h3>ğŸ“‹ ë¶ˆëŸ‰ êµ¬ê°„ ë¡œê·¸</h3>
<div id="logContainer" style="white-space: pre-wrap; border: 1px solid #ccc; padding: 10px; max-height: 200px; overflow-y: auto;">
  <!-- ì—¬ê¸° ë¡œê·¸ê°€ í‘œì‹œë©ë‹ˆë‹¤ -->
</div>

<script>
  const API_BASE = "http://localhost:8000";

  const cctvSelect = document.getElementById('cctvSelect');
  const startBtn = document.getElementById('startAnalysisBtn');
  const img = document.getElementById('streaming');
  const resultVideo = document.getElementById('resultVideo');
  const resultSource = document.getElementById('resultSource');
  const logContainer = document.getElementById('logContainer');

  let pollingInterval = null;

  // ğŸ“ CCTV íŒŒì¼ ëª©ë¡ ë¡œë“œ
  window.onload = async () => {
    try {
      const res = await fetch(`${API_BASE}/cctv/files`);
      const data = await res.json();

      if (data.files && Array.isArray(data.files)) {
        data.files.forEach(file => {
          const option = document.createElement('option');
          option.value = file;
          option.textContent = file;
          cctvSelect.appendChild(option);
        });
      } else {
        alert('CCTV íŒŒì¼ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    } catch (err) {
      console.error(err);
      alert('CCTV íŒŒì¼ ëª©ë¡ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
  };

  // â–¶ï¸ ë¶„ì„ ì‹œì‘
  startBtn.onclick = async () => {
    const selectedFile = cctvSelect.value;
    if (!selectedFile) {
      alert("ë¶„ì„í•  CCTV íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.");
      return;
    }

    // ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
    if (pollingInterval) {
      clearInterval(pollingInterval);
      pollingInterval = null;
    }

    // ì´ˆê¸°í™”
    resultVideo.style.display = 'none';
    logContainer.innerHTML = '';
    img.style.display = 'block';
    const timestamp = Date.now();
    img.src = `${API_BASE}/stream/cctv_video?filename=${encodeURIComponent(selectedFile)}&t=${timestamp}`;

    // ë¶„ì„ ìš”ì²­
    try {
      const res = await fetch(`${API_BASE}/predict/cctv_video`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ filename: selectedFile })
      });

      if (!res.ok) {
        const error = await res.json();
        alert(`ë¶„ì„ ì‹œì‘ ì‹¤íŒ¨: ${error.detail || res.statusText}`);
        return;
      }
    } catch (err) {
      console.error(err);
      alert('ë¶„ì„ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      return;
    }

    // ìƒíƒœ í™•ì¸ í´ë§
    pollingInterval = setInterval(async () => {
      try {
        const statusRes = await fetch(`${API_BASE}/predict/status`);
        const status = await statusRes.json();

        if (status.done) {
          clearInterval(pollingInterval);
          pollingInterval = null;

          img.style.display = 'none';

          resultSource.src = `${API_BASE}/predict/result`;
          resultVideo.style.display = 'block';
          resultVideo.load();
          resultVideo.play();

          if (Array.isArray(status.logs) && status.logs.length > 0) {
            logContainer.innerHTML = '';
            status.logs.forEach(interval => {
              if (Array.isArray(interval) && interval.length === 2) {
                const p = document.createElement('p');
                p.textContent = `${interval[0].toFixed(2)}ì´ˆ ~ ${interval[1].toFixed(2)}ì´ˆ`;
                logContainer.appendChild(p);
              }
            });
          } else {
            logContainer.textContent = 'ë¶ˆëŸ‰ êµ¬ê°„ì´ ê°ì§€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.';
          }
        }
      } catch (err) {
        console.error(err);
        clearInterval(pollingInterval);
        alert('ìƒíƒœ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }, 1000);
  };
</script>
